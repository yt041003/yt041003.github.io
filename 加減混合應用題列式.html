<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>數學王國：神獸試煉 V13 (題目顯示修復版)</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Press+Start+2P&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a1a1a;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }
        
        .pixel-font { font-family: 'Press Start 2P', cursive; }

        /* VFX Animations */
        @keyframes fire-burst { 0% { transform: scale(0); opacity: 1; } 50% { opacity: 0.8; } 100% { transform: scale(3); opacity: 0; } }
        @keyframes water-stream { 0% { width: 0; opacity: 0.8; transform: rotate(-45deg); } 100% { width: 150%; opacity: 0; transform: rotate(-45deg) translate(-100px, -100px); } }
        @keyframes thunder-bolt { 0% { height: 0; opacity: 1; } 50% { height: 100%; opacity: 1; } 100% { height: 100%; opacity: 0; } }
        @keyframes leaf-spin { 0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(720deg); opacity: 0; } }
        @keyframes shockwave { 0% { transform: scale(0.1); border-width: 20px; opacity: 1; } 100% { transform: scale(2); border-width: 0px; opacity: 0; } }
        @keyframes shake-anim { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-15px); } 75% { transform: translateX(15px); } }

        .anim-fire { animation: fire-burst 0.6s ease-out forwards; }
        .anim-water { animation: water-stream 0.5s cubic-bezier(0.1, 0.7, 1.0, 0.1) forwards; }
        .anim-thunder-bolt { animation: thunder-bolt 0.3s ease-out forwards; }
        .anim-leaf { animation: leaf-spin 0.8s ease-out forwards; }
        .anim-shockwave { animation: shockwave 0.6s ease-out forwards; }

        /* Pokemon Animations */
        .monster-idle { animation: float 3s ease-in-out infinite; }
        .animate-shake { animation: shake-anim 0.3s ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .game-screen {
            max-width: 600px; margin: 0 auto; height: 100dvh;
            display: flex; flex-direction: column; background: #2d3748;
            position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.7);
        }
        
        .hp-container {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
            border: 2px solid #fff;
            border-radius: 8px;
            padding: 4px 8px;
            width: 220px; 
            margin-bottom: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Backgrounds ---
        const bgImages = {
            forest: "https://img.freepik.com/free-vector/hand-drawn-flat-design-forest-landscape_23-2149157285.jpg", 
            city: "https://img.freepik.com/free-vector/nature-landscape-with-road-city-horizon-trees-clouds-sky-summer-scene-with-empty-highway-green-fields-road-sign-town-buildings-vector-cartoon-illustration_107791-21641.jpg", 
            sky: "https://img.freepik.com/free-vector/blank-sky-night-scene-with-blank-flood-landscape_1308-60757.jpg"
        };

        const gyms = [
            { id: 1, monsterId: 150, name: "超夢", title: "神秘森林", bg: bgImages.forest },
            { id: 2, monsterId: 249, name: "洛奇亞", title: "歡樂市區", bg: bgImages.city },
            { id: 3, monsterId: 384, name: "烈空坐", title: "天空之城", bg: bgImages.sky }
        ];

        // --- Move Database ---
        const moveDatabase = {
            electric: [
                { name: "電擊", color: "bg-yellow-500" },
                { name: "十萬伏特", color: "bg-yellow-600" },
                { name: "電球", color: "bg-yellow-400" },
                { name: "打雷", color: "bg-yellow-700" }
            ],
            fire: [
                { name: "火花", color: "bg-red-500" },
                { name: "火焰輪", color: "bg-red-600" },
                { name: "噴射火焰", color: "bg-red-700" },
                { name: "大字爆炎", color: "bg-red-800" }
            ],
            water: [
                { name: "水槍", color: "bg-blue-500" },
                { name: "泡沫光線", color: "bg-blue-400" },
                { name: "衝浪", color: "bg-blue-600" },
                { name: "水炮", color: "bg-blue-700" }
            ],
            grass: [
                { name: "藤鞭", color: "bg-green-500" },
                { name: "飛葉快刀", color: "bg-green-600" },
                { name: "能量球", color: "bg-green-400" },
                { name: "陽光烈焰", color: "bg-green-700" }
            ]
        };

        const starterPool = [
            { id: 25, name: "皮卡丘", type: "electric" },
            { id: 6, name: "噴火龍", type: "fire" },
            { id: 9, name: "水箭龜", type: "water" },
            { id: 3, name: "妙蛙花", type: "grass" }
        ];

        const getSprite = (id, back=false) => 
            `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${back ? 'back/' : ''}${id}.gif`;

        // --- Full Question Bank ---
        const fullQuestionBank = [
            { q: "表哥有郵票 27 枚，表姐有郵票 24 枚，表哥用去 8 枚，表姐用去 10 枚後，兩人現有的郵票相差多少枚？", a: 5 },
            { q: "攝錄機每部售 6540 元，數碼相機每部售 2184 元，即影即有相機每部售 495 元，何先生選購了最貴的兩款器材各一部，店員自動減價 490 元，結果何先生只需付多少元？", a: 8234 },
            { q: "電器展覽，第一天參觀的有 1063 人，第二天參觀的比第一天多了 267 人，這兩天來參觀的共有多少人？", a: 2393 },
            { q: "爸爸每月的薪金是 8100 元，比媽媽的多 1320 元，兩人每月的薪金共有多少元？", a: 14880 }, 
            { q: "微波爐每部售 2850 元，比雪櫃每部便宜 1569 元，買 1 部微波爐和 1 部雪櫃，共需付多少元？", a: 7269 },
            { q: "電視機每部售 5833 元，比冷氣機每部的售價貴 2645 元，買 1 部電視機和 1 部冷氣機，共需付多少元？", a: 9021 }, 
            { q: "新開張的影視店有中文影碟 4050 張，比外語影碟多 1326 張，兩種影碟共有多少張？", a: 6774 },
            { q: "小英昨天寫字 97 個，今天比昨天少寫 23 個，兩天共寫字幾個？", a: 171 },
            { q: "餐桌每張售 980 元，餐椅一張比餐桌一張便宜 575 元。買餐桌和餐椅各一張，共需付多少元？", a: 1385 },
            { q: "某新落成的屋苑上個月售出了 2350 個單位，今個月售出的單位比上個月的少 983 個，這兩個月共售出單位多少個？", a: 3717 },
            { q: "噴射船下層有乘客 368 人，比上層多 104 人，全船共有乘客多少人？", a: 632 }, 
            { q: "開學了，哥哥的書簿費 345 元，弟弟的書簿費 280 元，媽媽把 1000 元交給學校，應找回多少元？", a: 375 },
            { q: "家強駕車到 3300 公里外的地方旅行。第一天行駛了 720 公里，第二天行駛了 645 公里，還要行駛多少公里才到達目的地？", a: 1935 },
            { q: "某城上月進口了 2315 輛私家車，634 輛貨車和 129 輛巴士，這三類汽車共進口了多少輛？", a: 3078 },
            { q: "名歌星演唱會共有入場券 2000 張，上午售出 472 張，下午售出 1256 張，還未售出的有多少張？", a: 272 },
            { q: "圖書館有圖書 3050 本，今天借出 692 本，歸還 1134 本，圖書館現有圖書多少本？", a: 3492 },
            { q: "超級市場原有即食麪 1400 包，售出 628 包後，運來 780 包，現在超級市場有即食麪多少包？", a: 1552 },
            { q: "媽媽有 5000 元，買洗衣機用去 3850 元後，她到銀行提取 2150 元，她現有多少元？", a: 3300 },
            { q: "一隊士兵原有 3652 人，開戰後有 1094 人被調派到另一分隊。幾天後派來 1258 人，這隊士兵現有多少人？", a: 3816 },
            { q: "爸爸原有 3564 元，他從銀行提取 5000 元，買電視機用去 6990 元，還餘下多少元？", a: 1574 },
            { q: "貨倉原有貨物 6115 箱，上午再運來 3409 箱，下午運走了 994 箱，貨倉裏現有貨物多少箱？", a: 8530 },
            { q: "停車場裏原來停泊了汽車 1029 輛。今天有 534 輛駛進停車場，另有 788 輛離開，現在停車場裏還有汽車多少輛？", a: 775 },
            { q: "製衣廠上月製成成衣 3600 套，本月製成成衣 4580 套，售出 6500 套後，還有成衣多少套？", a: 1680 },
            { q: "米店原有越南白米 1270 包，泰國白米 2534 包。售出 1786 包白米後，還餘白米多少包？", a: 2018 },
            { q: "果欄原有鮮橙 1250 箱，工人運來 3378 箱後，售去 3904 箱，還有鮮橙多少箱？", a: 724 },
            { q: "圖書館原有圖書 2600 本，今年添購了 1235 本，丟棄了 109 本損壞的圖書，圖書館現有圖書多少本？", a: 3726 },
            { q: "一部攝錄機售 2184 元，一部相機售 495 元，李先生只有 2500 元，他想購買一部攝錄機和一部相機，還欠多少元？", a: 179 },
            { q: "爸爸買售價 7560 元的電腦一部，和 680 元的電腦桌一張，付 9000 元給店員，應找回多少元？", a: 760 },
            { q: "一部攝錄機售 6540 元，一部相機售 495 元。叔叔付 8000 元買攝錄機和相機各一部，應找回多少元？", a: 965 },
            { q: "超級市場原有即食麪 1200 包，昨天售出 562 包，今天又運來 960 包，現有即食麪多少包？", a: 1598 },
            { q: "火車由總站開出時有乘客 1092 人，到第一個站時有 78 人下車，又有 354 人上車，這時車上有乘客多少人？", a: 1368 },
            { q: "李宅上月的電費 865 元，煤氣費 274 元。李先生現在只有 1090 元，還欠多少元才足夠繳交電費和煤氣費？", a: 49 },
            { q: "小雞一隻重 1198 克，大雞重 2084 克，大雞和小雞的重量相差多少克？", a: 886 },
            { q: "陳小姐有 3696 元，還欠 1897 元便可購買一隻金錶，這隻金錶的售價是多少元？", a: 5593 },
            { q: "李小姐原有 5302 元，買鑽石戒指後，她還有 2654 元，她買鑽石戒指用去多少元？", a: 2648 },
            { q: "展覽館第一天有 5348 人進場，第二天比第一天少 1022 人，第三天又比第二天少 1234 人。第三天進場的人數有多少人？", a: 3092 },
            { q: "哥哥有 965 元，妹妹有 1859 元，弟弟有 1060 元。三人的錢剛好可購買一部電腦，這部電腦的售價是多少元？", a: 3884 },
            { q: "壽司店有三文魚壽司 1657 件，甜蝦壽司比三文魚壽司多 364 件，甜蝦壽司有多少件？", a: 2021 },
            { q: "果園原有蘋果 2362 個，賣出 1368 個後，還有蘋果多少個？", a: 994 },
            { q: "爸爸原有 9586 元，買電視用去 6326 元後，還有多少元？", a: 3260 },
            { q: "志明本月儲蓄了 2654 元，上月儲蓄了 1682 元。這兩個月共儲蓄了多少元？", a: 4336 },
            { q: "水族店有 34 條鯛魚，魟魚比鯛魚少 15 條，這兩種魚共有多少條？", a: 53 },
            { q: "橙汁有 356 盒，蘋果汁比橙汁少 117 盒。這兩種果汁共有多少盒？", a: 595 },
            { q: "永俊的體重是 55 公斤，婷婷比他輕 8 公斤，兩人共重多少公斤？", a: 102 },
            { q: "永俊有 108 枚郵票，婷婷的郵票比永俊的少 35 枚，他們共有郵票多少枚？", a: 181 },
            { q: "書櫃裏有 461 本中文書，英文書比中文書少 197 本。中、英文書共有多少本？", a: 725 },
            { q: "貨倉內有急凍豬肉 204 公斤，急凍雞肉比急凍豬肉少 77 公斤。這兩種肉共有多少公斤？", a: 331 },
            { q: "某小學舉辦籌款活動，分兩天進行，籌款目標是 8000 元。第二天籌得 5643 元，與第一天籌得的善款合計，超出目標 1325 元。第一天籌得善款多少元？", a: 3682 }, 
            { q: "緩跑徑長 1080 米，哥哥從起點開始已跑了 843 米，這時弟弟落後哥哥 176 米，現在弟弟距離緩跑徑終點還有多少米？", a: 413 }, 
            { q: "店主把原本定價 5680 元的電視機的標價牌改為 6340 元，聲稱再減 350 元出售。店主以新售價賣出一部電視機，比用原來定價賣出，可多賺多少元？", a: 310 }, 
            { q: "學校舉辦籌款活動，低年級籌得 3542 元，中年級籌得 4588 元，高年級比低年級多籌得 842 元，高年級籌得的善款比中年級少多少元？", a: 204 }, 
            { q: "工人從貨倉搬走 1240 箱貨物後，再把另外 2645 箱貨物搬入貨倉，貨倉現在有貨物 4088 箱，貨倉原有貨物多少箱？", a: 2683 }, 
            { q: "雜貨店上月買入雞蛋 1045 隻，丟掉壞蛋 98 隻後，賣出部分雞蛋，店內還有雞蛋 237 隻，雜貨店賣去雞蛋多少隻？", a: 710 },
            { q: "姊姊只有 3840 元，不足夠買一條售 4840 元的金手鏈，只好買一條比金手鏈便宜 1068 元的銀手鏈，買銀手鏈後，姊姊還餘多少元？", a: 68 }, 
            { q: "餐椅一張售 1088 元，媽媽付 3000 元買了兩張餐椅，找回多少元？", a: 824 },
            { q: "鐵線長 3418 厘米，銅線長 2036 厘米，銅線比鋼線短 537 厘米，鐵線比鋼線長多少厘米？", a: 845 }, 
            { q: "球場坐有觀眾 1325 人，還有空座位 309 個，後來又有人入場，觀眾增至 1532 人，球場現有空座位多少個？", a: 102 }, 
            { q: "戲院第一場有觀眾 1028 人，第二場的觀眾比第一場少 142 人，兩場共有觀眾多少人？", a: 1914 },
            { q: "媽媽付 4000 元買了一部售 1640 元的三輪單車和一部兩輪單車，找回 425 元，那部兩輪單車售多少元？", a: 1935 }, 
            { q: "哥哥有 932 元，弟弟有 837 元，二人想合資購買一部 1800 元的電子遊戲機，二人還欠多少元？", a: 31 },
            { q: "哥哥的銀行存款原有 6824 元，取出 1032 元後，再存入 1324 元。哥哥的銀行存款現有多少元？", a: 7116 },
            { q: "餅店售出傳統月餅 2850 盒，比冰皮月餅多售出 954 盒，餅店共售出月餅多少盒？", a: 4746 }, 
            { q: "學校舉行運動會，女運動員有 327 人，比男運動員少 193 人，運動員共有多少人？", a: 847 },
            { q: "王先生和李先生參加步行籌款。王先生籌得 356 元，李先生比他多 124 元，兩人共籌得善款多少元？", a: 836 },
            { q: "江小姐的月薪比胡小姐的少1385元，亦比朱先生的少2165元。朱先生的月薪是8215元。胡小姐的月薪是多少元？", a: 7435 }, 
            { q: "何小姐有現金1275元，領了薪金8450元後，買了一套價值986元的衣服，現在她有多少元？", a: 8739 },
            { q: "黃太太的銀行存款有8723元，她提取了2945元，後來再存入支票3678元。現在她的銀行存款有多少元？", a: 9456 },
            { q: "陳先生的月薪是7800元，上月的開支包括日常開支5298元和額外開支639元，他還有多少元？", a: 1863 },
            { q: "蛋糕每個 22 元，牛奶每盒 11 元。家恩買了一個蛋糕和一盒牛奶，她給售貨員一張 50 元紙幣，應找回多少元？", a: 17 },
            { q: "貨倉上月存有白米7200公斤，本月初運走了5844公斤，本月中再存入2364公斤。貨倉現有白米多少公斤？", a: 3720 },
            { q: "星期五售出 3095 張獎券，星期六售出 2166 張，星期五和星期六共售出的獎券比星期日的多 2856 張。星期日售出獎券多少張？", a: 2405 }, 
            { q: "廚師預備了5485份食物，來賓吃去3124份，廚師再多做了2745份，現有食物多少份？", a: 5106 },
            { q: "展覽會會場原有 3748 人。後來有 1328 人進入，3567 人離開。會場內現有多少人？", a: 1509 },
            { q: "買一袋橙和一盒士多啤梨(假設共40元)，付50元，應找回多少元？(依文字題義)", a: 10 }, 
            { q: "四月來港的內地旅客有5530人，五月的內地旅客比四月的多2563人，六月的內地旅客比五月少1826人。六月的內地旅客有多少人？", a: 6267 },
            { q: "水晶禮品店星期五的收入是 3756 元，星期六的收入比星期五的少 1210 元，星期日的收入比星期六的多 2315 元。星期日的收入是多少元？", a: 4861 },
            { q: "泰國五天團的團費是1388元，學生可便宜250元，另收導遊費525元，就讀中五的志強參加了這個團，共需付多少元？", a: 1663 }, 
            { q: "姐姐的銀行戶口有存款4520元，得到獎學金後再存入1800元，後來又提取了300元，現她的戶口有存款多少元？", a: 6020 },
            { q: "圖書館買來 65 本新書，其中有故事書 40 本，剩下的是謎語書。謎語書比故事書少幾本 ?", a: 15 }, 
            { q: "學校買了彩色粉筆 45 盒，買白色粉筆比買彩色粉筆多 15 盒。學校共買了粉筆多少盒 ?", a: 105 },
            { q: "星期六參觀茶具展覽的男性有1624人，女性有1839人。全日共有多少人參觀？", a: 3463 },
            { q: "星期日上午有1346人參觀茶具展覽，下午比上午多2597人。下午共有多少人參觀？", a: 3943 },
            { q: "星期二的入場券收入有3675元，星期三的有2928元，星期四的有1688元，三日的入場券收入共有多少元？", a: 8291 },
            { q: "星期日遊樂場的入場人數有3678人，比星期六的多841人，星期五的入場人數比星期六的少1005人，星期五的入場人數有多少人？", a: 1832 }, 
            { q: "興建一條長3000米的公路，上半年完成了1108米，下半年完成了912米，未興建的還有多少米？", a: 980 },
            { q: "琪琪的銀行戶口原有存款5228元，昨天存入1420元，今天又存入2385元，現她的銀行戶口有存款多少元？", a: 9033 },
            { q: "貨倉有鉛筆 3965 枝，比原子筆少 1148 枝，兩種筆共有多少枝？", a: 9078 }, 
            { q: "美勞室裏有白畫紙 5831 張，比黑畫紙多 2548 張，黑畫紙比黃色畫紙多 1394 張。美勞室裏有黃色畫紙多少張？", a: 1889 }, 
            { q: "遊樂場原有紀念品 8030 份，昨天派了 3252 份，今天派了 3899 份，還有紀念品多少份？", a: 879 },
            { q: "往北京的機票售 2820 元，比往日本的機票便宜 1395 元，而往澳洲的機票又比往日本的貴 1995 元。往澳洲的機票售多少元？", a: 6210 }, 
            { q: "小文有 3592 元，美芬有 2925 元，小玲有 1259 元，三人共有多少元？", a: 7776 },
            { q: "博物館在星期日的入場人數有 356 人，比星期六的多 119 人，兩日的入場人數共有多少人？", a: 593 },
            { q: "百貨公司售出裙子若干件，其中長裙佔 137 件，比短裙多 28 件，即售出裙子多少件？", a: 246 }, 
            { q: "壽司師傅做了 276 件三文魚壽司，海膽壽司比三文壽司多 185 件，這兩款壽司共有多少件？", a: 737 },
            { q: "參加步行籌款的女童軍有 127 人，比男童軍少 59 人，共有童軍多少人？", a: 313 },
            { q: "温室內有仙人掌 247 盆，菊花比仙人掌多 168 盆，兩種盆栽共有多少盆？", a: 662 },
            { q: "玩具車的售價是 277 元，玩具船比玩具車貴 192 元。買一輛玩具車和一艘玩具船，需付多少元？", a: 746 },
            { q: "問答比賽派出了初級組的報名表 377 張，高級組的比初級組的多派 86 張，兩組共派出報名表多少張？", a: 840 }
        ];

        // --- Helper Components ---

        const Timer = ({ isActive, startTime }) => {
            const [elapsed, setElapsed] = useState(0);

            useEffect(() => {
                if (!isActive || !startTime) return;
                const timerId = setInterval(() => {
                    setElapsed(Math.floor((Date.now() - startTime) / 1000));
                }, 1000);
                return () => clearInterval(timerId);
            }, [isActive, startTime]);

            const fmt = (s) => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, '0')}`;
            return (
                <div className="absolute top-4 left-4 z-50 bg-black/70 border-2 border-white px-3 py-2 rounded text-white font-mono pixel-font text-lg shadow-lg">
                    TIME: {fmt(elapsed)}
                </div>
            );
        };

        const BattleVFX = ({ type, onComplete }) => {
            useEffect(() => { const t = setTimeout(onComplete, 1000); return () => clearTimeout(t); }, []);
            
            if (type === 'fire') return (
                <div className="absolute inset-0 z-40 flex items-center justify-center pointer-events-none">
                     <div className="w-32 h-32 bg-red-500 rounded-full blur-xl anim-fire absolute"></div>
                     <div className="w-48 h-48 bg-orange-500 rounded-full blur-md anim-fire absolute delay-100"></div>
                </div>
            );
            if (type === 'water') return (
                <div className="absolute inset-0 z-40 pointer-events-none overflow-hidden">
                     <div className="absolute bottom-0 left-0 w-[200%] h-32 bg-blue-400 blur-md anim-water origin-bottom-left border-4 border-white"></div>
                </div>
            );
            if (type === 'electric') return (
                <div className="absolute inset-0 z-40 pointer-events-none">
                    <div className="absolute top-0 left-1/2 w-24 h-full bg-yellow-400 anim-thunder-bolt"></div>
                    <div className="absolute inset-0 bg-white animate-pulse opacity-50"></div>
                </div>
            );
            if (type === 'grass') return (
                <div className="absolute inset-0 z-40 pointer-events-none">
                    {[...Array(10)].map((_,i) => <div key={i} className="absolute w-6 h-6 bg-green-500 rounded-full anim-leaf" style={{left: Math.random()*100+'%', top: Math.random()*100+'%', '--tx': (Math.random()*200-100)+'px', '--ty': (Math.random()*200-100)+'px'}}></div>)}
                </div>
            );
            return <div className="absolute inset-0 z-40 flex items-center justify-center"><div className="w-full h-full border-8 border-white rounded-full anim-shockwave"></div></div>;
        };

        const HPBar = ({ current, max, name, isPlayer }) => {
            const pct = Math.max(0, (current / max) * 100);
            let color = "bg-green-500";
            if (pct <= 50) color = "bg-yellow-400";
            if (pct <= 25) color = "bg-red-600";

            return (
                <div className="hp-container">
                    <div className="flex justify-between text-white text-xs font-bold mb-1">
                        <span className="truncate mr-2">{name}</span>
                        {isPlayer && <span>{current}/{max}</span>}
                    </div>
                    <div className="w-full bg-gray-800 rounded-full h-2.5 border border-gray-600 overflow-hidden">
                        <div className={`h-full ${color} transition-all duration-500`} style={{ width: `${pct}%` }}></div>
                    </div>
                </div>
            );
        };

        const Keypad = ({ onInput, onDelete, onEnter }) => {
             const rows = [
                ["(", ")", "C", "DEL"],
                ["7", "8", "9", "+"],
                ["4", "5", "6", "-"],
                ["1", "2", "3", "×"],
                ["0", "OK"]
            ];

            return (
                <div className="grid grid-cols-4 gap-2 h-full bg-gray-800 p-2 rounded border border-gray-600 select-none">
                    {rows.flat().map((btn, idx) => {
                        let spanClass = "";
                        if (btn === "0") spanClass = "col-span-2";
                        if (btn === "OK") spanClass = "col-span-2";
                        
                        return (
                            <button 
                                key={`${btn}-${idx}`} 
                                onClick={(e) => {
                                    e.preventDefault();
                                    btn==="OK"?onEnter():btn==="C"?onDelete(true):btn==="DEL"?onDelete(false):onInput(btn)
                                }}
                                onTouchStart={(e) => {
                                    e.target.classList.add('bg-opacity-50');
                                }}
                                onTouchEnd={(e) => {
                                    e.target.classList.remove('bg-opacity-50');
                                }}
                                className={`rounded-lg font-bold text-xl active:scale-95 active:brightness-75 border-b-4 border-black/20 flex items-center justify-center shadow transition-all ${spanClass} ${
                                    ["C","DEL"].includes(btn)?"bg-red-800 text-white":
                                    ["OK"].includes(btn)?"bg-green-700 text-white":
                                    ["+","-","×","(",")"].includes(btn)?"bg-orange-500 text-white":
                                    "bg-gray-200 text-gray-900"
                                }`}
                            >
                                {btn}
                            </button>
                        );
                    })}
                </div>
            );
        };

        // --- Main Game ---

        const Game = () => {
            const [state, setState] = useState('intro'); // intro, battle, victory, gameover
            const [gymIdx, setGymIdx] = useState(0);
            
            // 使用題庫 Deck 概念，確保題目隨機且不重複
            const [questionDeck, setQuestionDeck] = useState([]);
            const [deckIndex, setDeckIndex] = useState(0);
            
            const [startTime, setStartTime] = useState(null);
            const [finalTime, setFinalTime] = useState(0);
            
            const [player, setPlayer] = useState(null);
            const [pHP, setPHP] = useState(3);
            const [eHP, setEHP] = useState(3);
            
            const [msg, setMsg] = useState("");
            const [mode, setMode] = useState("keypad"); // keypad, move, wait
            const [input, setInput] = useState("");
            const [vfx, setVfx] = useState(null);
            const [shake, setShake] = useState(false);

            // 初始化時洗牌所有題目
            const shuffleQuestions = () => {
                return [...fullQuestionBank].sort(() => 0.5 - Math.random());
            };

            const startGame = (p) => {
                setPlayer(p);
                setQuestionDeck(shuffleQuestions()); // 洗牌
                setDeckIndex(0); // 重置索引
                setGymIdx(0);
                setPHP(3);
                setEHP(3);
                setStartTime(Date.now());
                setState('battle');
                setMsg(`挑戰開始！進入${gyms[0].title}！`);
                setMode('keypad');
                setInput("");
                
                // --- 修復點1：自動清除開始訊息，讓題目顯示 ---
                setTimeout(() => {
                    setMsg("");
                }, 2000);
            };

            const handleAnswer = () => {
                if (!input) return;
                
                if (!/[\+\-\*×0-9()]/.test(input)) {
                     setMsg("請輸入有效的數字！");
                     setTimeout(() => setMsg(""), 1000);
                     return;
                }
                
                let expr = input.replace(/×/g, '*');
                try {
                    const userAns = new Function(`return ${expr}`)();
                    // 獲取當前題目
                    const currentQ = questionDeck[deckIndex];
                    
                    if (!currentQ) {
                        setMsg("題目加載錯誤，正在重置...");
                        setDeckIndex(0);
                        setTimeout(() => setMsg(""), 1000);
                        return;
                    }

                    if (Math.abs(userAns - currentQ.a) < 0.01) {
                        setMsg("正確！請選擇招式攻擊！");
                        // 這裡不自動清除，因為需要選擇招式
                        setMode('move');
                    } else {
                        // 答錯邏輯：扣血，但保留題目，清空輸入，讓玩家重試
                        setMsg(`算錯了！受到反擊！再試一次！`);
                        setShake(true);
                        setTimeout(()=>setShake(false), 300);
                        setPHP(p => {
                            const newHp = p - 1;
                            if (newHp <= 0) setTimeout(() => setState('gameover'), 1000);
                            return newHp;
                        });
                        setInput(""); // 清空輸入欄方便重試
                        
                        // --- 修復點2：答錯訊息顯示 1.5 秒後消失，顯示題目 ---
                        setTimeout(() => {
                            setMsg("");
                        }, 1500);
                    }
                } catch (e) {
                    setMsg("算式無效！");
                    setTimeout(() => setMsg(""), 1000);
                }
            };

            const attack = (moveName) => {
                setMode('wait');
                setMsg(`${player.name} 使用了 ${moveName}！`);
                // 這裡的 msg 會在 VFX 結束後被覆蓋
                setVfx(player.type); 
                setInput("");
            };

            const onVfxEnd = () => {
                setVfx(null);
                setShake(true);
                setTimeout(() => setShake(false), 500);
                
                setEHP(prev => {
                    const next = prev - 1;
                    if (next <= 0) {
                        handleGymClear();
                        return 0;
                    } else {
                        setMsg("命中要害！敵人受傷了！");
                        // 只有在攻擊成功（即答對並出招後）才換下一題
                        setDeckIndex(i => i + 1);
                        setMode('keypad');
                        // 攻擊後的訊息也需要消失
                        setTimeout(() => setMsg(""), 1500);
                        return next;
                    }
                });
            };

            const handleGymClear = () => {
                setMsg(`${gyms[gymIdx].name} 倒下了！道館突破！`);
                
                // 過關也換下一題，避免下一關開始時還是同一題
                setDeckIndex(i => i + 1);

                if (gymIdx < gyms.length - 1) {
                    setTimeout(() => {
                        setGymIdx(g => g + 1);
                        setEHP(3); // 重置敵人血量
                        setMsg(`前往下一站... ${gyms[gymIdx+1].title}！`);
                        setMode('keypad');
                        
                        // --- 修復點3：切換關卡後，訊息自動消失 ---
                        setTimeout(() => setMsg(""), 2000);
                    }, 2000);
                } else {
                    setFinalTime(Math.floor((Date.now() - startTime)/1000));
                    setTimeout(() => setState('victory'), 2000);
                }
            };

            // --- Render ---

            if (state === 'intro') return (
                <div className="game-screen bg-gray-900 text-white items-center justify-center p-6 text-center">
                    <h1 className="text-4xl md:text-5xl text-yellow-400 pixel-font mb-8 leading-snug drop-shadow-lg animate-pulse">
                        數學王國<br/><span className="text-2xl md:text-3xl text-white">神獸試煉 V13</span>
                    </h1>
                    <div className="text-gray-300 mb-6">請選擇你的夥伴：</div>
                    <div className="grid grid-cols-2 gap-4 w-full max-w-sm">
                        {starterPool.map(s => (
                            <button 
                                key={s.id} 
                                onClick={() => startGame(s)} 
                                className="bg-gray-800 p-4 rounded-xl border-2 border-gray-600 hover:border-yellow-400 hover:bg-gray-700 transition active:scale-95 flex flex-col items-center"
                            >
                                <img src={getSprite(s.id)} className="w-20 h-20" alt={s.name} />
                                <div className="mt-2 font-bold">{s.name}</div>
                            </button>
                        ))}
                    </div>
                </div>
            );

            if (state === 'battle') {
                const currentGym = gyms[gymIdx];
                // 安全獲取題目，如果題庫用完（不太可能，因為有80多題），則重置
                let currentQ = questionDeck[deckIndex];
                if (!currentQ && questionDeck.length > 0) {
                     // 循環利用
                     currentQ = questionDeck[deckIndex % questionDeck.length];
                }

                return (
                    <div className="game-screen" style={{backgroundImage: `url(${currentGym.bg})`, backgroundSize: 'cover', backgroundPosition: 'center'}}>
                        {/* Timer */}
                        <Timer isActive={true} startTime={startTime} />
                        
                        {/* VFX Overlay */}
                        {vfx && <BattleVFX type={vfx} onComplete={onVfxEnd} />}

                        {/* Battle Scene */}
                        <div className="flex-1 relative overflow-hidden">
                            {/* Opponent */}
                            <div className={`absolute top-12 right-6 flex flex-col items-end transition-transform duration-100 ${shake ? 'translate-x-2' : ''}`}>
                                <HPBar current={eHP} max={3} name={currentGym.name} isPlayer={false} />
                                <img src={getSprite(currentGym.monsterId)} className="w-32 h-32 md:w-40 md:h-40 object-contain drop-shadow-xl monster-idle" />
                            </div>

                            {/* Player */}
                            <div className="absolute bottom-4 left-6 flex flex-col items-start">
                                <img src={getSprite(player.id, true)} className="w-32 h-32 md:w-40 md:h-40 object-contain drop-shadow-xl" />
                                <HPBar current={pHP} max={3} name={player.name} isPlayer={true} />
                            </div>
                        </div>

                        {/* UI Panel */}
                        <div className="bg-gray-900 border-t-4 border-yellow-500 p-4 rounded-t-3xl shadow-2xl h-[50%] md:h-[45%] flex flex-col z-30">
                            {/* Question/Message Box - 這裡如果 msg 是空字串，就會顯示題目 */}
                         <div className="bg-gray-800 p-3 rounded-lg border border-gray-600 mb-2 h-32 md:h-40 flex items-center justify-center text-center overflow-y-auto">
                                <span className="text-white font-bold text-sm md:text-lg leading-relaxed px-2">
                                    {msg ? msg : (currentQ ? currentQ.q : "載入中...")}
                                </span>
                            </div>
                            
                            {/* Controls */}
                            <div className="flex-1">
                                {mode === 'keypad' && (
                                    <div className="h-full flex flex-col">
                                        <div className="bg-black text-green-400 font-mono text-xl p-2 rounded mb-2 text-right tracking-widest border border-gray-600 h-12 flex items-center justify-end">
                                            {input || <span className="animate-pulse text-gray-600">_</span>}
                                        </div>
                                        <div className="flex-1">
                                            <Keypad 
                                                onInput={(k) => setInput(i => i + k)} 
                                                onDelete={(all) => setInput(i => all ? "" : i.slice(0, -1))}
                                                onEnter={handleAnswer} 
                                            />
                                        </div>
                                    </div>
                                )}
                                {mode === 'move' && (
                                    <div className="h-full flex flex-col justify-center">
                                        <div className="text-gray-400 text-center mb-2 text-sm">選擇攻擊招式</div>
                                        <div className="grid grid-cols-2 gap-3 h-full pb-2">
                                            {moveDatabase[player.type].map(m => (
                                                <button 
                                                    key={m.name} 
                                                    onClick={() => attack(m.name)} 
                                                    className={`${m.color} text-white rounded-xl font-bold text-lg shadow-lg border-b-4 border-black/20 active:scale-95 active:border-b-0 translate-y-0 active:translate-y-1 transition-all flex items-center justify-center`}
                                                >
                                                    {m.name}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {mode === 'wait' && (
                                    <div className="h-full flex items-center justify-center">
                                        <div className="text-white text-xl animate-bounce">
                                            戰鬥進行中...
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (state === 'victory') return (
                <div className="game-screen bg-yellow-600 flex flex-col items-center justify-center text-white p-8 text-center relative overflow-hidden">
                    <div className="absolute inset-0 bg-yellow-500 opacity-50 animate-pulse"></div>
                    <div className="z-10">
                        <h1 className="text-4xl md:text-6xl pixel-font mb-6 drop-shadow-xl text-yellow-100">VICTORY!</h1>
                        <p className="text-xl mb-8 font-bold">恭喜你成為數學冠軍！</p>
                        <div className="text-2xl font-mono bg-black/40 p-6 rounded-xl border-2 border-yellow-200 mb-10">
                            總耗時: <span className="text-yellow-300">{finalTime}</span> 秒
                        </div>
                        <button 
                            onClick={() => window.location.reload()} 
                            className="bg-white text-yellow-800 px-8 py-4 rounded-full font-bold text-xl shadow-xl hover:scale-110 transition border-4 border-yellow-300"
                        >
                            再次挑戰
                        </button>
                    </div>
                </div>
            );

            if (state === 'gameover') return (
                <div className="game-screen bg-gray-900 flex flex-col items-center justify-center text-white p-8 text-center">
                    <h1 className="text-4xl md:text-5xl pixel-font text-red-500 mb-6 tracking-widest">GAME OVER</h1>
                    <p className="mb-10 text-gray-400 text-lg">你的數學之旅暫時結束了...</p>
                    <button 
                        onClick={() => window.location.reload()} 
                        className="bg-red-600 text-white px-10 py-4 rounded-full font-bold text-xl shadow-lg hover:bg-red-500 transition hover:scale-105"
                    >
                        重新開始
                    </button>
                </div>
            );

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Game />);
    </script>
</body>
</html>
